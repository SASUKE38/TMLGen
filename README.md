# TMLGen

 This tool generates the TML file for a given Baldur's Gate 3 cutscene, allowing the cinematic to be easily edited in an unlocked version of the toolkit (such as [MoonGlasses](https://www.nexusmods.com/baldursgate3/mods/12308?tab=description)).

## Usage

The tool requires the path to your unpacked game directory (as unpacked by the [Baldur's Gate 3 Modder's Multitool](https://github.com/ShinyHobo/BG3-Modders-Multitool)) along with the source file of the timeline you wish to edit.
Additionally, you may select the timeline data to use manually. The definitions below detail the data the tool uses. Note that only the first two are needed for automatic selection; the rest may be ignored.
- Unpacked Data Directory: Top level of unpacked game data.
- Source File: .lsf source file of the timeline you wish to edit. Likely located in a Timeline\Generated directory.
- Generated Dialog Timelines File: .lsf file that contains information linking the timeline and dialog. Likely located in a Content\Generated\[PAK]_GeneratedDialogTimelines directory.
- Dialogs Binary File: .lsf file that contains the compiled dialog data. Likely located in a Story\DialogsBinary directory.
- Timeline Templates Directory: Not required (will not be present for timelines with no templates). Contains the templates a timeline uses.

### Linking a .tml File

The steps below detail how to link a generated .tml file to its dialog. The editor currently does not seem to support overriding timelines directly; these steps detail a method to overcome this restriction.

1. Open an unlocked version of the Baldur's Gate 3 toolkit.
2. Find the dialog you wish to edit in the Resource Manager.
3. Right click on the dialog and select 'Override in the Active Mod...'
4. Open the dialog.
5. Select Tools > Timeline > Unlink (Convinces the editor not to put the timeline in a vanilla package).
6. Select Tools > Timeline > Generate > Full Copper.
7. Locate the generated source and scene files in your mod's Timeline\Generated folder.
8. Replace these files with the originals from the unpacked game data. Make sure they have the same name as the dialog (the editor appends "_000" to the name when overriding dialog).
9. Locate the .tml file generated by the editor in your mod's Editor\Mods\mod name\Timeline\Generated directory. This is not the same location as the source and scene files.
10. Replace this file with the one generated from the TMLGen tool. Make sure it has the same name as the replaced .tml.
11. Return to the opened dialog.
12. Open the timeline.

## Known Limitations and Workarounds

- The tool currently has only been tested on the "Generic NPC Dialog" category, which encompasses most dialogs. World/Behavior dialog is not yet supported.
- Generation does not give actors descriptive names, relying instead on names like "Additional 2" or "Initiator 1." You can find their actual names by referencing the dialog's speaker list or by hovering over the actor's track.
- The timeline's initial location is not set by the tool, and must be set by hand.
- Slot materials might not work correctly as is. To overcome this, try the following steps:
  1. Select the actor that owns the slot material.
  2. Locate the Visual Resource ID property in the sidebar and copy the associated GUID.
  3. Open the generated .tml file in a text editor.
  4. Use the Find feature (CTRL + F) to search for "CharacterVisualResourceId" (no quotes).
  5. Identify which instance of this string is associated with the slot material. It should be under a track that has the name of the actor in question. If there are multiple slot materials, they will be ordered in the same way they appear in the toolkit.
  6. Replace the CharacterVisualResourceId GUID of the slot material with the one you copied from the editor. Close and reopen the timeline (do not refresh; this will overwrite the change you made).
  7. If the slot material still does not work, try adding another version of the slot material.
  8. Open the .tml in a text editor once again.
  9. Locate the slot material you added as you did above.
  10. Copy this slot material's CharacterVisualResourceId and replace the slot material of the one you want to get working.
  11. Note that some actors support different versions of the same slot material; it might be unclear which to use for this process, so multiple tries with this method might be necessary.
 - Actors taken from the world might not work correctly as is (this is not in reference to them not appearing - make sure that you have the correct level loaded if their name is in red) To overcome this, try the following steps.
   1. Make a backup of the .tml file.
   2. Note the name of the actor when you hover over it.
   3. Delete the actor and re-add it.
   4. Select the actor in the sidebar.
   5. If the Parent Template ID is not null (all zeros), copy it.
   6. Undo the changes or restore the backup of the .tml file.
   7. Open the .tml file in a text editor.
   8. Use the Find feature (CTRL + F) to search for the name of the actor.
   9. Replace the ParentTemplateId with the one you copied. If no such attribute is present, add it with the form ParentTemplateId="00000000-0000-0000-0000-000000000000"

## Known Issues

- Only the first of grouped cinematic nodes appears in the Playlists tab. This can be fixed by opening the dialog and selecting Tools > Timeline > Generate > Refresh.
